"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[262],{24262:(e,t,r)=>{r.r(t),r.d(t,{Whiteboard:()=>g});var n=r(54568),i=r(7620),l=r(5275),o=r(99779),a=r(65754),c=r(2838),s=r(75454),u=r(52059),d=r(19769),f=r(65202),h=r(71094),w=r.n(h);let p=(0,i.memo)((0,i.forwardRef)((e,t)=>(0,n.jsx)("canvas",{ref:t,className:"block w-full h-full"})),()=>!0);p.displayName="StaticCanvas";let g=e=>{let{roomId:t}=e,r=(0,i.useRef)(null),h=(0,i.useRef)(null),g=(0,i.useRef)(null),[m,v]=(0,i.useState)([]),[b,y]=(0,i.useState)(!1),x=(0,i.useRef)(!1),E=(0,i.useRef)(!1),R=(0,i.useRef)(!1),k=(0,i.useRef)(0),L=(0,i.useRef)(0),A=(0,i.useRef)(null),C=(0,i.useRef)(null),j=(0,i.useRef)(a.p.SELECTION),O=(0,i.useRef)("#000000"),N=(0,i.useRef)(2),S=(0,i.useRef)(1),I=(0,i.useRef)(0),M=(0,i.useRef)((()=>{let e=["#f87171","#fbbf24","#34d399","#60a5fa","#818cf8","#a78bfa","#f472b6"];return e[Math.floor(Math.random()*e.length)]})()),T=(0,i.useRef)(new Map),q=(0,i.useRef)(new Map),W=(0,i.useRef)(new Map),z=(0,i.useRef)("Guest"),Y=(0,i.useRef)([]),D=(0,i.useRef)(-1),P=(0,i.useRef)(!1),{activeTool:X,strokeColor:U,strokeWidth:H,fillColor:_,roughness:B,opacity:F,cornerRadius:G,isDarkMode:Z,gridType:J,setRoomId:V,roomHost:$}=(0,o.P)();(0,i.useEffect)(()=>{V(t)},[t,V]),(0,i.useEffect)(()=>{y(!0)},[]),(0,i.useEffect)(()=>{try{{let e=localStorage.getItem("opensketch_username");e&&e.trim()&&(z.current=e.trim().slice(0,24))}}catch(e){}},[]),(0,i.useEffect)(()=>{let e=e=>{let r=((null==e?void 0:e.detail)||"").toString().trim().slice(0,24);if(r){z.current=r;try{var n;null==(n=g.current)||n.emit("introduce",{roomId:t,name:z.current,color:M.current})}catch(e){}}};return window.addEventListener("user:name-changed",e),()=>window.removeEventListener("user:name-changed",e)},[t]),(0,i.useEffect)(()=>{if(j.current=X,O.current=U,N.current=H,S.current=F,I.current=G,es(),h.current){let r=h.current.getActiveObject();if(r){let n=!1;if(r.opacity!==F&&(r.set("opacity",F),n=!0),"rect"===r.type)r.set({rx:G,ry:G}),n=!0;else if("image"===r.type){if(G>0){let e=new l.rw({width:r.width,height:r.height,rx:G,ry:G,originX:"center",originY:"center"});r.clipPath=e}else r.clipPath=void 0;n=!0}if(n){var e;h.current.requestRenderAll();let n=r.toObject(["id","opacity"]);null==(e=g.current)||e.emit("drawing-data",{roomId:t,...n})}}}},[X,U,H,F,G]);let K=e=>{var t,r,n,i,l,o,a,c;if(!e)return{x:0,y:0};let s=e.touches;if(s&&"number"==typeof s.length&&s.length>0){let e=s[0]||{};return{x:null!=(r=null!=(t=e.clientX)?t:e.pageX)?r:0,y:null!=(i=null!=(n=e.clientY)?n:e.pageY)?i:0}}return{x:null!=(o=null!=(l=e.clientX)?l:e.pageX)?o:0,y:null!=(c=null!=(a=e.clientY)?a:e.pageY)?c:0}},Q=(e,t,r,n)=>{let i=Math.atan2(n-t,r-e),l={x:r-20*Math.cos(i-Math.PI/6),y:n-20*Math.sin(i-Math.PI/6)},o={x:r-20*Math.cos(i+Math.PI/6),y:n-20*Math.sin(i+Math.PI/6)},a=(e+r)/2,c=(t+n)/2,s=e=>({x:e.x-a,y:e.y-c}),u=s({x:e,y:t}),d=s({x:r,y:n}),f=s(l),h=s(o);return{d:"M ".concat(u.x," ").concat(u.y," L ").concat(d.x," ").concat(d.y," M ").concat(d.x," ").concat(d.y," L ").concat(f.x," ").concat(f.y," M ").concat(d.x," ").concat(d.y," L ").concat(h.x," ").concat(h.y),left:a,top:c}},ee=()=>{if(!h.current)return;let e=h.current,t=Z?"#18181b":"#ffffff",r=Z?"#3f3f46":"#e5e7eb";if(J===a.j.NONE){e.backgroundColor=t,e.requestRenderAll();return}let n=J===a.j.LINES?'<defs><pattern id="grid" width="'.concat(20,'" height="').concat(20,'" patternUnits="userSpaceOnUse"><path d="M ').concat(20," 0 L 0 0 0 ").concat(20,'" fill="none" stroke="').concat(r,'" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(#grid)" />'):'<defs><pattern id="dots" width="'.concat(20,'" height="').concat(20,'" patternUnits="userSpaceOnUse"><circle cx="1" cy="1" r="1" fill="').concat(r,'" /></pattern></defs><rect width="100%" height="100%" fill="url(#dots)" />'),i="data:image/svg+xml;base64,".concat(btoa('<svg width="100%" height="100%" xmlns="http://www.w3.org/2000/svg">'.concat(n,"</svg>"))),o=new Image;o.src=i,o.onload=()=>{h.current&&(h.current.backgroundColor=new l.zJ({source:o,repeat:"repeat"}),h.current.requestRenderAll())}},et=()=>{if(P.current||!h.current)return;D.current<Y.current.length-1&&(Y.current=Y.current.slice(0,D.current+1));let e=h.current.toObject(["id","selectable","evented","opacity"]),t=Array.isArray(e.objects)?e.objects:[];e.objects=t.filter(e=>{let t=null==e?void 0:e.id;return!("string"==typeof t&&t.startsWith("cursor-"))}),delete e.background,delete e.backgroundColor,delete e.backgroundImage;let r=JSON.stringify(e);Y.current.push(r),D.current=Y.current.length-1,Y.current.length>50&&(Y.current.shift(),D.current--)},er=async()=>{if(h.current)try{el(!1);let e=h.current.toDataURL({format:"png",multiplier:2}),t=await (await fetch(e)).blob();await navigator.clipboard.write([new ClipboardItem({"image/png":t})]),el(!0),await w().fire({toast:!0,position:"bottom-start",icon:"success",timer:1600,showConfirmButton:!1,title:"Gambar berhasil disalin"})}catch(e){el(!0),console.error("Failed to copy image:",e),await w().fire({icon:"error",title:"Gagal menyalin",text:"Tidak bisa menyalin gambar ke clipboard."})}},en=e=>{var r;if(!h.current)return;let n=h.current.getActiveObject();if(!n)return;"up"===e?n.bringToFront():n.sendBackwards(),h.current.requestRenderAll(),et();let i=n.toObject(["id","opacity"]);null==(r=g.current)||r.emit("drawing-data",{roomId:t,...i})},ei=async e=>{var t;if(!h.current)return;let r=JSON.parse(e),n=new Map(T.current);await h.current.loadFromJSON(r),ee();let i=h.current;i&&(i.getObjects().forEach(e=>{var t;(null==(t=e.id)?void 0:t.startsWith("cursor-"))||ec(e)}),n.forEach(e=>{i.contains(e)||i.add(e)})),null==(t=h.current)||t.requestRenderAll(),P.current=!1},el=e=>{var t;T.current.forEach(t=>{t.visible=e}),null==(t=h.current)||t.requestRenderAll()};(0,i.useEffect)(()=>{let e=()=>void(D.current>0&&(P.current=!0,D.current--,ei(Y.current[D.current]))),r=()=>void(D.current<Y.current.length-1&&(P.current=!0,D.current++,ei(Y.current[D.current]))),n=()=>(()=>{let e=h.current;if(!e)return;let t=e.getZoom();(t*=1.1)>5&&(t=5);let r=e.width||0,n=e.height||0;e.zoomToPoint(new l.bR(r/2,n/2),t),e.requestRenderAll()})(),i=()=>(()=>{let e=h.current;if(!e)return;let t=e.getZoom();(t/=1.1)<.2&&(t=.2);let r=e.width||0,n=e.height||0;e.zoomToPoint(new l.bR(r/2,n/2),t),e.requestRenderAll()})(),o=()=>(()=>{if(!h.current)return;let e=h.current;el(!1);let t=e.toDataURL({format:"png",quality:1,multiplier:2,enableRetinaScaling:!0});el(!0);let r=document.createElement("a");r.download="opensketch-".concat(new Date().toISOString().slice(0,10),".png"),r.href=t,document.body.appendChild(r),r.click(),document.body.removeChild(r)})(),a=()=>(()=>{if(!h.current)return;let e=h.current;el(!1);let t=e.toSVG();el(!0);let r=new Blob([t],{type:"image/svg+xml;charset=utf-8"}),n=URL.createObjectURL(r),i=document.createElement("a");i.download="opensketch-".concat(new Date().toISOString().slice(0,10),".svg"),i.href=n,document.body.appendChild(i),i.click(),document.body.removeChild(i)})(),c=()=>(()=>{if(!h.current)return;let e=h.current;el(!1);let t=e.toDataURL({format:"png",quality:1,multiplier:2});el(!0);let r=new u.uE("l","mm","a4"),n=r.internal.pageSize.getWidth(),i=r.internal.pageSize.getHeight(),l=r.getImageProperties(t),o=l.width/l.height,a=n,c=n/o;c>i&&(c=i,a=i*o);let s=(n-a)/2,d=(i-c)/2;r.addImage(t,"PNG",s,d,a,c),r.save("opensketch-".concat(new Date().toISOString().slice(0,10),".pdf"))})(),d=()=>er(),f=()=>(()=>{if(!h.current)return;let e=h.current;el(!1);let t=e.toDataURL({format:"png",quality:1,multiplier:2,enableRetinaScaling:!0}),r=new Image;r.src=t,r.onload=()=>{let e=document.createElement("canvas"),t=e.getContext("2d");if(!t)return;e.width=r.width,e.height=r.height,t.drawImage(r,0,0);let n=Math.max(20,.02*r.width),i=1.5*n,l=1.4*n,o=r.height-i;t.shadowColor="rgba(0, 0, 0, 0.9)",t.shadowBlur=4,t.shadowOffsetX=1,t.shadowOffsetY=1,t.fillStyle="#ffffff",t.strokeStyle="#ffffff",t.save(),t.translate(i+l/2,o-l/2-.1*n),t.rotate(-45*Math.PI/180),t.fillRect(-l/6,-l/2,l/3,.6*l),t.beginPath(),t.moveTo(-l/6,.1*l),t.lineTo(0,.5*l),t.lineTo(l/6,.1*l),t.closePath(),t.fill(),t.restore(),t.font="bold ".concat(n,"px 'Segoe UI', Roboto, Helvetica, Arial, sans-serif"),t.textAlign="left",t.textBaseline="alphabetic",t.fillText("Powered by Hanif Abdurrohim | OpenSketch",i+1.2*l,o);let a=e.toDataURL("image/png");window.dispatchEvent(new CustomEvent("whiteboard:screenshot-ready",{detail:a})),el(!0)}})(),w=e=>(e=>{let r=e.detail;l.Ng.fromURL(r).then(e=>{var r;if(!h.current)return;let n=h.current,i=.5*n.width;e.width>i&&e.scaleToWidth(i),e.set({left:(n.width-e.width*e.scaleX)/2,top:(n.height-e.height*e.scaleY)/2,id:(0,s.A)(),opacity:S.current,selectable:!0,evented:!0,cornerStyle:"circle",cornerColor:"white",borderColor:"#3b82f6",transparentCorners:!1}),n.add(e),n.setActiveObject(e),n.requestRenderAll();let l=e.toObject(["id","opacity"]);null==(r=g.current)||r.emit("drawing-data",{roomId:t,...l}),et()})})(e),p=()=>en("up"),m=()=>en("down"),v=e=>{let t=e.detail,r=h.current;if(!r||!t)return;let n=q.current.get(t);if(!n)return;let i=(r.viewportTransform||[1,0,0,1,0,0]).slice(),o=r.getZoom();i[4]=r.getWidth()/2-n.x*o,i[5]=r.getHeight()/2-n.y*o,r.setViewportTransform(i);let a=new l.jl({left:n.x-20,top:n.y-20,radius:20,fill:"rgba(59,130,246,0.2)",stroke:"#2563eb",strokeWidth:3,selectable:!1,evented:!1,opacity:0});r.add(a),r.requestRenderAll();let c=!0,s=setInterval(()=>{a.set("opacity",.9*!!c),c=!c,r.requestRenderAll()},200);setTimeout(()=>{clearInterval(s),r.remove(a),r.requestRenderAll()},2e3)};return window.addEventListener("whiteboard:undo",e),window.addEventListener("whiteboard:redo",r),window.addEventListener("whiteboard:zoom-in",n),window.addEventListener("whiteboard:zoom-out",i),window.addEventListener("whiteboard:export-png",o),window.addEventListener("whiteboard:export-svg",a),window.addEventListener("whiteboard:export-pdf",c),window.addEventListener("whiteboard:copy-img",d),window.addEventListener("whiteboard:request-screenshot",f),window.addEventListener("whiteboard:insert-image",w),window.addEventListener("whiteboard:layer-up",p),window.addEventListener("whiteboard:layer-down",m),window.addEventListener("whiteboard:locate-user",v),()=>{window.removeEventListener("whiteboard:undo",e),window.removeEventListener("whiteboard:redo",r),window.removeEventListener("whiteboard:zoom-in",n),window.removeEventListener("whiteboard:zoom-out",i),window.removeEventListener("whiteboard:export-png",o),window.removeEventListener("whiteboard:export-svg",a),window.removeEventListener("whiteboard:export-pdf",c),window.removeEventListener("whiteboard:copy-img",d),window.removeEventListener("whiteboard:request-screenshot",f),window.removeEventListener("whiteboard:insert-image",w),window.removeEventListener("whiteboard:layer-up",p),window.removeEventListener("whiteboard:layer-down",m),window.removeEventListener("whiteboard:locate-user",v)}},[]);let eo=(0,i.useRef)(((e,t)=>{let r;return function(){for(var n=arguments.length,i=Array(n),l=0;l<n;l++)i[l]=arguments[l];r||(e.apply(this,i),r=!0,setTimeout(()=>r=!1,t))}})(e=>{var t;null==(t=g.current)||t.emit("cursor-move",e)},50)).current,ea=(0,i.useRef)(30);(0,i.useEffect)(()=>{try{let e=localStorage.getItem("opensketch_eraser_size"),t=e?parseInt(e):30;!isNaN(t)&&t>0&&t<=200&&(ea.current=t)}catch(e){}let e=e=>{let t="number"==typeof(null==e?void 0:e.detail)?e.detail:NaN;!isNaN(t)&&t>0&&t<=200&&(ea.current=t)};return window.addEventListener("whiteboard:eraser-size",e),()=>window.removeEventListener("whiteboard:eraser-size",e)},[]),(0,i.useEffect)(()=>{var e,r,n;try{let e=localStorage.getItem("opensketch_username");e&&(z.current=e)}catch(e){}g.current=(0,c.io)("https://server.art.haniipp.space",{path:"/socket.io"}),t&&g.current.emit("join-room",t),g.current.on("drawing-data",e=>{if(!h.current)return;let t=h.current.getObjects().find(t=>t.id===e.id);P.current=!0,t?(t.set(e),t.setCoords(),h.current.requestRenderAll(),P.current=!1,et()):l.ZS.enlivenObjects([e]).then(t=>{var r;t.forEach(t=>{var r;t.id=e.id,ec(t),null==(r=h.current)||r.add(t)}),null==(r=h.current)||r.requestRenderAll(),P.current=!1,et()})}),g.current.on("delete-object",e=>{if(!h.current)return;let t=h.current.getObjects().find(t=>t.id===e);t&&(P.current=!0,h.current.remove(t),h.current.requestRenderAll(),P.current=!1,et())}),g.current.on("cursor-move",e=>{var t;if(!h.current)return;let{userId:r,x:n,y:i,color:o}=e;q.current.set(r,{x:n,y:i});let a=W.current.get(r),c=null==a?void 0:a.name;c||(null==(t=g.current)?void 0:t.id)!==r||(c=z.current);let s=!c||""===c.trim()||"guest"===c.trim().toLowerCase(),u=T.current.get(r);if(u){let e=u.getObjects()[1];if(s){h.current.remove(u),T.current.delete(r),h.current.requestRenderAll();return}e&&e.text!==c&&e.set({text:c}),u.set({left:n,top:i}),u.setCoords()}else{if(s)return;let e=((e,t,r)=>{let n;if(0===e)n=new l.wA("M 0 0 L 22 11 L 11 22 Z",{fill:t,stroke:"white",strokeWidth:1,selectable:!1,evented:!1,originX:"left",originY:"top"});else if(1===e)n=new l.wA("M 11 0 L 22 11 L 11 22 L 0 11 Z",{fill:t,stroke:"white",strokeWidth:1,selectable:!1,evented:!1,originX:"left",originY:"top"});else{let e=new l.jl({left:2,top:2,radius:10,fill:"transparent",stroke:t,strokeWidth:3,selectable:!1,evented:!1}),r=new l.jl({left:7,top:7,radius:5,fill:t,stroke:"white",strokeWidth:1,selectable:!1,evented:!1});n=new l.YJ([e,r],{selectable:!1,evented:!1,originX:"left",originY:"top"})}let i=new l.EY(r,{fontSize:14,fontFamily:"sans-serif",fill:"#ffffff",backgroundColor:t,selectable:!1,evented:!1,originX:"left",originY:"bottom",left:20,top:-5,rx:4,ry:4,padding:4});return new l.YJ([n,i],{selectable:!1,evented:!1,opacity:.9,subTargetCheck:!1})})((e=>{let t=0;for(let r=0;r<e.length;r++)t=31*t+e.charCodeAt(r)>>>0;return t%3})(r),o,c);e.left=n,e.top=i,e.id="cursor-".concat(r),h.current.add(e),T.current.set(r,e)}if(!W.current.has(r)){W.current.set(r,{id:r,name:c,color:o});let e=Array.from(W.current.values());v(e);try{window.__participants=e}catch(e){}try{window.dispatchEvent(new CustomEvent("participants:update",{detail:e}))}catch(e){}}h.current.requestRenderAll()}),g.current.on("user-disconnected",e=>{let t=T.current.get(e);t&&h.current&&(h.current.remove(t),T.current.delete(e),h.current.requestRenderAll())}),g.current.on("participants",e=>{let t=Array.isArray(e)?e.filter(e=>e&&"string"==typeof e.name&&e.name.trim()&&"guest"!==e.name.trim().toLowerCase()):[];v(t);let r=new Map;t.forEach(e=>r.set(e.id,e)),W.current=r;try{window.__participants=t}catch(e){}try{window.dispatchEvent(new CustomEvent("participants:update",{detail:t}))}catch(e){}}),setTimeout(()=>{try{var e,r;null==(e=g.current)||e.emit("introduce",{roomId:t,name:z.current,color:M.current});let n=null==(r=g.current)?void 0:r.id;if(n&&!W.current.has(n)){W.current.set(n,{id:n,name:z.current,color:M.current});let e=Array.from(W.current.values());v(e);try{window.__participants=e}catch(e){}try{window.dispatchEvent(new CustomEvent("participants:update",{detail:e}))}catch(e){}}}catch(e){}},300);let i=e=>{var t,r;let n=null==e||null==(t=e.detail)?void 0:t.id,i=null==e||null==(r=e.detail)?void 0:r.opacity;if(!h.current||"number"!=typeof i)return;let l=h.current.getObjects().find(e=>e.id===n);l&&"image"===l.type&&(l.set({opacity:i}),l.setCoords(),h.current.requestRenderAll(),et())},o=e=>{var t,r;let n=null==e||null==(t=e.detail)?void 0:t.id,i=null==e||null==(r=e.detail)?void 0:r.stroke;if(!h.current||!i)return;let l=h.current.getObjects().find(e=>e.id===n);l&&"image"===l.type&&(l.set({stroke:i}),l.setCoords(),h.current.requestRenderAll(),et())},a=e=>{var t,r;let n=null==e||null==(t=e.detail)?void 0:t.id,i=null==e||null==(r=e.detail)?void 0:r.strokeWidth;if(!h.current||"number"!=typeof i)return;let l=h.current.getObjects().find(e=>e.id===n);l&&"image"===l.type&&(l.set({strokeWidth:i}),l.setCoords(),h.current.requestRenderAll(),et())},s=e=>{var t,r,n,i,l,o;let a=null==e||null==(t=e.detail)?void 0:t.id,c=null==e||null==(r=e.detail)?void 0:r.action;if(!h.current||!c)return;let s=h.current.getObjects().find(e=>e.id===a);s&&("bringToFront"===c?null==(n=s.bringToFront)||n.call(s):"sendToBack"===c?null==(i=s.sendToBack)||i.call(s):"bringForward"===c?null==(l=s.bringForward)||l.call(s):"sendBackwards"===c&&(null==(o=s.sendBackwards)||o.call(s)),h.current.requestRenderAll(),et())};window.addEventListener("image:opacity",i),window.addEventListener("image:stroke",o),window.addEventListener("image:strokeWidth",a),window.addEventListener("image:layer",s);let u=()=>{if(!h.current)return;let e=h.current.getActiveObject();if(e&&"image"===e.type)try{var t;let r={id:e.id,opacity:null!=(t=e.opacity)?t:1,stroke:e.stroke||"#000000",strokeWidth:e.strokeWidth||0};window.dispatchEvent(new CustomEvent("image-sidebar:show",{detail:r}))}catch(e){}else try{window.dispatchEvent(new CustomEvent("image-sidebar:hide"))}catch(e){}};return null==(e=h.current)||e.on("selection:created",u),null==(r=h.current)||r.on("selection:updated",u),null==(n=h.current)||n.on("selection:cleared",u),()=>{var e,t,r,n;null==(e=g.current)||e.disconnect(),window.removeEventListener("image:opacity",i),window.removeEventListener("image:stroke",o),window.removeEventListener("image:strokeWidth",a),window.removeEventListener("image:layer",s),null==(t=h.current)||t.off("selection:created",u),null==(r=h.current)||r.off("selection:updated",u),null==(n=h.current)||n.off("selection:cleared",u)}},[t]),(0,i.useEffect)(()=>{if(!b||!r.current||x.current)return;let e=!1,n=requestAnimationFrame(()=>{if(e||!r.current)return;let n=new l.Hl(r.current,{width:window.innerWidth,height:window.innerHeight,selection:!0,backgroundColor:Z?"#18181b":"#ffffff",preserveObjectStacking:!0,stopContextMenu:!0,fireRightClick:!0});h.current=n,x.current=!0,et(),es();let i=()=>{let e=n.getActiveObject();if(e&&"image"===e.type)try{let t={id:e.id,opacity:"number"==typeof e.opacity?e.opacity:1,stroke:e.stroke||"#000000",strokeWidth:"number"==typeof e.strokeWidth?e.strokeWidth:0};window.dispatchEvent(new CustomEvent("image-sidebar:show",{detail:t}))}catch(e){}else try{window.dispatchEvent(new CustomEvent("image-sidebar:hide"))}catch(e){}};n.on("selection:created",i),n.on("selection:updated",i),n.on("selection:cleared",i),n.on("mouse:down",i),window.addEventListener("resize",()=>{h.current&&h.current.setDimensions({width:window.innerWidth,height:window.innerHeight})}),n.on("mouse:wheel",function(e){if(!e||!e.e)return;let t=e.e,r="number"==typeof t.deltaY?t.deltaY:0,i=n.getZoom();(i*=Math.pow(.999,r))>5&&(i=5),i<.2&&(i=.2);let o="number"==typeof t.offsetX?t.offsetX:"number"==typeof t.clientX?t.clientX:0,a="number"==typeof t.offsetY?t.offsetY:"number"==typeof t.clientY?t.clientY:0,c=new l.bR(o,a);n.zoomToPoint(c,i),"function"==typeof t.preventDefault&&t.preventDefault(),"function"==typeof t.stopPropagation&&t.stopPropagation()}),n.on("mouse:down",eu),n.on("mouse:move",ed),n.on("mouse:up",ef),n.on("path:created",eh),n.on("object:modified",e=>{var r;et();let n=e.target;if(!n)return;let i=n.toObject(["id","opacity","stroke","strokeWidth","fill","left","top","scaleX","scaleY","angle","width","height"]);null==(r=g.current)||r.emit("drawing-data",{roomId:t,...i})})});return()=>{e=!0,cancelAnimationFrame(n);let t=h.current;if(t)try{t.off("selection:created"),t.off("selection:updated"),t.off("selection:cleared"),t.off("mouse:down")}catch(e){}t&&t.dispose(),h.current=null,x.current=!1}},[b]),(0,i.useEffect)(()=>{ee()},[Z,J]);let ec=e=>{e.id&&e.id.startsWith("cursor-")||(j.current===a.p.SELECTION?(e.evented=!0,e.selectable=!0):(e.evented=!1,e.selectable=!1))},es=()=>{if(!h.current)return;let e=h.current,t=j.current,r=t===a.p.PENCIL;if(e.selection=t===a.p.SELECTION,e.isDrawingMode=r,r){let t=new l.mW(e);t.width=N.current,t.color=((e,t)=>{let r=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return r?"rgba(".concat(parseInt(r[1],16),", ").concat(parseInt(r[2],16),", ").concat(parseInt(r[3],16),", ").concat(t,")"):e})(O.current,S.current),t.decimate=2.5,e.freeDrawingBrush=t}e.getObjects().forEach(e=>ec(e)),t===a.p.HAND?(e.defaultCursor="grab",e.hoverCursor="grab"):t===a.p.ERASER?(e.defaultCursor="cell",e.hoverCursor="cell"):t===a.p.SELECTION?(e.defaultCursor="default",e.hoverCursor="move"):(e.defaultCursor="crosshair",e.hoverCursor="crosshair"),e.requestRenderAll()},eu=e=>{let t=h.current;if(!t)return;let r=e.e,n=t.getPointer(r),i=j.current;if(i===a.p.HAND){r.preventDefault&&r.preventDefault(),R.current=!0,k.current=K(r).x,L.current=K(r).y,t.setCursor("grabbing");return}if(i===a.p.ERASER){r.preventDefault&&r.preventDefault(),E.current=!0,ew(n);return}if(i===a.p.SELECTION||i===a.p.PENCIL)return;E.current=!0,A.current={x:n.x,y:n.y};let o=(0,s.A)(),c={left:n.x,top:n.y,fill:"transparent"===_?"":_,stroke:O.current,strokeWidth:N.current,opacity:S.current,selectable:!1,evented:!1,originX:"left",originY:"top",id:o,strokeUniform:!0,cornerStyle:"circle",cornerColor:"white",borderColor:"#3b82f6",transparentCorners:!1},u=null;if(i===a.p.RECTANGLE)u=new l.rw({...c,width:0,height:0});else if(i===a.p.ROUND_RECT)u=new l.rw({...c,width:0,height:0,rx:10,ry:10});else if(i===a.p.CIRCLE)u=new l.Pp({...c,rx:0,ry:0});else if(i===a.p.TRIANGLE)u=new l.lM({...c,width:0,height:0});else if(i===a.p.RHOMBUS)u=new l.tS([{x:.5,y:0},{x:1,y:.5},{x:.5,y:1},{x:0,y:.5}],{...c,scaleX:0,scaleY:0});else if(i===a.p.HEXAGON)u=new l.tS([{x:.25,y:0},{x:.75,y:0},{x:1,y:.5},{x:.75,y:1},{x:.25,y:1},{x:0,y:.5}],{...c,scaleX:0,scaleY:0});else if(i===a.p.LINE)u=new l.N1([n.x,n.y,n.x,n.y],c);else if(i===a.p.ARROW){let e=Q(n.x,n.y,n.x,n.y);(u=new l.wA(e.d,{...c,left:e.left,top:e.top,originX:"center",originY:"center",fill:"",stroke:O.current})).centeredRotation=!0}else if(i===a.p.TEXT){let e=new l.DA("Type here",{...c,fontFamily:"Inter, sans-serif",fontSize:24,fill:O.current});t.add(e),t.setActiveObject(e),e.enterEditing(),e.selectable=!0,e.evented=!0,E.current=!1,et();return}u&&(t.add(u),C.current=u)},ed=e=>{let r=h.current;if(!r)return;let n=e.e,i=r.getPointer(n);eo({roomId:t,x:i.x,y:i.y,color:M.current});let o=j.current;if(o===a.p.HAND&&R.current){n.preventDefault&&n.preventDefault();let e=K(n),t=e.x-k.current,i=e.y-L.current;r.relativePan(new l.bR(t,i)),k.current=e.x,L.current=e.y;return}if(o===a.p.ERASER&&E.current)return void ew(i);if(!E.current||!C.current||!A.current)return;let c=A.current.x,u=A.current.y,d=C.current,f=Math.min(c,i.x),w=Math.min(u,i.y),p=Math.abs(c-i.x),g=Math.abs(u-i.y);if(["rectangle","round_rect","triangle"].includes(o))d.set({left:f,top:w,width:p,height:g});else if(o===a.p.CIRCLE)d.set({left:f,top:w,rx:p/2,ry:g/2});else if(o===a.p.RHOMBUS||o===a.p.HEXAGON)d.set({left:f,top:w,scaleX:p,scaleY:g});else if(o===a.p.LINE)d.set({x2:i.x,y2:i.y});else if(o===a.p.ARROW){let e=Q(c,u,i.x,i.y),t=d?d.toObject():{},n=d&&d.id||(0,s.A)();r.remove(d);let o=new l.wA(e.d,{...t,id:n,left:e.left,top:e.top,originX:"center",originY:"center",fill:"",stroke:O.current});o.centeredRotation=!0,r.add(o),C.current=o}r.requestRenderAll()},ef=()=>{let e=h.current;if(e){if(j.current===a.p.HAND){R.current=!1,e.setCursor("grab");return}if(E.current=!1,C.current){var r;let e=C.current;e.setCoords();let n=e.toObject(["id","opacity"]);null==(r=g.current)||r.emit("drawing-data",{roomId:t,...n}),et(),C.current=null}}},eh=e=>{var r;if(!e||!e.path)return;let n=e.path;n.set({id:(0,s.A)(),opacity:S.current,selectable:j.current===a.p.SELECTION,evented:j.current===a.p.SELECTION});let i=n.toObject(["id","opacity"]);null==(r=g.current)||r.emit("drawing-data",{roomId:t,...i}),et()},ew=e=>{let r=h.current;if(!r)return;let n=r.getZoom(),i=ea.current/n,o=r.getObjects(),a=!1;for(let n=o.length-1;n>=0;n--){let f=o[n];if(f.id&&f.id.startsWith("cursor-"))continue;let w=f.intersectsWithRect(new l.bR(e.x-i/2,e.y-i/2),new l.bR(e.x+i/2,e.y+i/2)),p=f.containsPoint(new l.bR(e.x,e.y));if(w||p){var c,s,u,d;if("image"===f.type){let e=Math.max(0,("number"==typeof f.opacity?f.opacity:1)-Math.min(.22,Math.max(.04,Math.max(6,Math.min(120,ea.current))/600)));if(f.set({opacity:e}),f.setCoords(),r.requestRenderAll(),a=!0,e<=.02)r.remove(f),null==(c=g.current)||c.emit("delete-object",{roomId:t,id:f.id});else{let e=f.toObject(["id","opacity"]);null==(s=g.current)||s.emit("drawing-data",{roomId:t,...e})}}else{let e=Math.max(0,("number"==typeof f.opacity?f.opacity:1)-Math.min(.22,Math.max(.04,Math.max(6,Math.min(120,ea.current))/600)));if(f.set({opacity:e}),f.setCoords(),r.requestRenderAll(),a=!0,e<=.02)h.current.remove(f),null==(u=g.current)||u.emit("delete-object",{roomId:t,id:f.id});else{let e=f.toObject(["id","opacity"]);null==(d=g.current)||d.emit("drawing-data",{roomId:t,...e})}}}}a&&et()};return b?(0,n.jsxs)("div",{className:"w-full h-full relative overflow-hidden bg-neutral-100 dark:bg-zinc-900",style:{touchAction:"none"},children:[(0,n.jsx)("div",{className:"absolute inset-0 w-full h-full z-0",children:(0,n.jsx)(p,{ref:r})}),(0,n.jsx)("div",{className:"absolute inset-0 w-full h-full z-10 pointer-events-none",children:m.length>0&&(0,n.jsxs)("div",{className:"hidden md:block absolute top-20 right-4 md:top-6 md:right-24 z-[9999] bg-white/90 dark:bg-zinc-800/90 backdrop-blur-sm border border-gray-200 dark:border-zinc-700 rounded-xl shadow-xl p-3 w-64 max-h-48 overflow-auto text-xs pointer-events-auto",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 font-bold text-gray-700 dark:text-gray-200 mb-2 pb-2 border-b border-gray-200 dark:border-zinc-700",children:[(0,n.jsx)(d.A,{size:14}),(0,n.jsxs)("span",{children:["Anggota (",m.length,")"]})]}),(0,n.jsx)("div",{className:"space-y-2",children:m.map(e=>(0,n.jsxs)("div",{className:"flex items-center justify-between gap-2 group",children:[(0,n.jsxs)("div",{className:"flex items-center gap-2 min-w-0",children:[(0,n.jsx)("span",{className:"inline-block w-2.5 h-2.5 rounded-full ring-1 ring-white/50",style:{backgroundColor:e.color}}),(0,n.jsx)("span",{className:"truncate text-gray-700 dark:text-gray-300 font-medium",children:e.name})]}),(0,n.jsx)("button",{className:"p-1.5 rounded-lg bg-blue-100 hover:bg-blue-200 text-blue-600 dark:bg-blue-900/50 dark:hover:bg-blue-800 dark:text-blue-200 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100",title:"Temukan Lokasi",onClick:()=>{let t=h.current,r=q.current.get(e.id);if(!t||!r)return;let n=new l.jl({left:r.x-20,top:r.y-20,radius:20,fill:"rgba(59,130,246,0.2)",stroke:"#2563eb",strokeWidth:3,selectable:!1,evented:!1,opacity:0});t.add(n);let i=t.viewportTransform||[1,0,0,1,0,0],o=t.getZoom();i[4]=t.getWidth()/2-r.x*o,i[5]=t.getHeight()/2-r.y*o,t.setViewportTransform(i),t.requestRenderAll();let a=!0,c=setInterval(()=>{n.set("opacity",.8*!!a),a=!a,t.requestRenderAll()},200);setTimeout(()=>{clearInterval(c),t.remove(n),t.requestRenderAll()},2e3)},children:(0,n.jsx)(f.A,{size:14})})]},e.id))})]})})]}):(0,n.jsx)("div",{className:"w-full h-full relative overflow-hidden bg-neutral-100 dark:bg-zinc-900",children:(0,n.jsx)("div",{className:"absolute inset-0 flex items-center justify-center text-gray-400",children:"Initializing..."})})}}}]);